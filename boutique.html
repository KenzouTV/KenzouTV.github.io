<script>
/* === boutique.full.js === */
(function(){
  /* NAV UNIFIÉE */
  const topbar = document.querySelector('nav.topbar');
  if (!topbar) return;
  document.querySelectorAll('.nav-overlay, .overlay-inner').forEach(n => n.remove());
  const navlinks = topbar.querySelector('.navlinks');
  if (!navlinks) return;

  let burger = document.getElementById('burger');
  if (!burger) {
    burger = document.createElement('button');
    burger.id = 'burger';
    burger.setAttribute('aria-expanded','false');
    burger.setAttribute('aria-controls','main-nav');
    burger.setAttribute('aria-label','Ouvrir le menu');
    burger.innerHTML = '<span class="bar" aria-hidden="true"></span><span class="bar" aria-hidden="true"></span><span class="bar" aria-hidden="true"></span>';
    topbar.appendChild(burger);
  }
  let mobileMenu = topbar.querySelector('.mobile-menu');
  if (!mobileMenu){
    mobileMenu = document.createElement('div');
    mobileMenu.className = 'mobile-menu';
    mobileMenu.setAttribute('role','menu');
    topbar.appendChild(mobileMenu);
  }
  function rebuildMobileMenu(){
    mobileMenu.innerHTML = '';
    navlinks.querySelectorAll('a, button').forEach(node=>{
      if (node.tagName.toLowerCase() === 'a') {
        const a = document.createElement('a');
        a.href = node.getAttribute('href') || '#';
        a.innerHTML = node.innerHTML;
        if (node.classList.contains('active')) a.classList.add('active');
        if (a.href.startsWith('http')) { a.setAttribute('target','_blank'); a.setAttribute('rel','noopener'); }
        a.addEventListener('click', ()=> closeMobileMenu());
        mobileMenu.appendChild(a);
      } else {
        const b = document.createElement('button');
        b.innerHTML = node.innerHTML;
        if (node.id) b.id = node.id + '-mobile';
        b.addEventListener('click', ()=>{
          if (node.id === 'btnDiscord' || node.classList.contains('btn-discord')) {
            window.open('https://discord.gg/KURpXHzRTE','_blank','noopener');
            closeMobileMenu();
          } else {
            try { node.click(); } catch(e){}
            closeMobileMenu();
          }
        });
        mobileMenu.appendChild(b);
      }
    });
  }
  function openMobileMenu(){ rebuildMobileMenu(); mobileMenu.classList.add('open'); burger.setAttribute('aria-expanded','true'); const first = mobileMenu.querySelector('a, button'); if (first) first.focus(); document.documentElement.style.overflow='hidden'; document.body.style.overflow='hidden'; }
  function closeMobileMenu(){ mobileMenu.classList.remove('open'); burger.setAttribute('aria-expanded','false'); document.documentElement.style.overflow=''; document.body.style.overflow=''; burger.focus(); }
  burger.addEventListener('click', (e)=> { e.stopPropagation(); mobileMenu.classList.contains('open') ? closeMobileMenu() : openMobileMenu(); });
  document.addEventListener('click', (e)=> { if (!mobileMenu.contains(e.target) && !burger.contains(e.target)) closeMobileMenu(); });
  window.addEventListener('keydown', (e)=> { if (e.key === 'Escape') closeMobileMenu(); });
  function checkNavOverflow(){ if (window.innerWidth >= 880) { topbar.classList.remove('compact'); return; } const tbRect = topbar.getBoundingClientRect(); const navRect = navlinks.getBoundingClientRect(); const marginRight = 60; const overflows = (navRect.right > (tbRect.right - marginRight)) || (navlinks.scrollWidth > navlinks.clientWidth); if (overflows) topbar.classList.add('compact'); else topbar.classList.remove('compact'); }
  window.addEventListener('load', ()=> setTimeout(checkNavOverflow,60));
  window.addEventListener('resize', ()=> setTimeout(checkNavOverflow,40));
  if (window.ResizeObserver){ const ro = new ResizeObserver(checkNavOverflow); ro.observe(navlinks); ro.observe(topbar); }
  checkNavOverflow();

  // Discord quick button
  const btnDiscord = document.getElementById('btnDiscord');
  if (btnDiscord) btnDiscord.addEventListener('click', ()=> window.open('https://discord.gg/KURpXHzRTE','_blank','noopener'));
  document.querySelectorAll('a[href^="http"]').forEach(a => { a.setAttribute('target','_blank'); a.setAttribute('rel','noopener'); });

  /* PRODUITS (modal) */
  const PRODUCTS = {
    'product-1': { id:'product-1', title:'Animation courte', price:'2€', img:'Produit-1.jpg', desc:'Intro/bumpers <1min. MP4 720p. 1 révision incluse.', paypal:'https://www.paypal.com/ncp/payment/GG7ZXTNYLZLS6' },
    'product-2': { id:'product-2', title:'Pack 3 animations', price:'5€', img:'Produit-2.jpg', desc:'Trois courts rendus séparés. Idéal pour séries.', paypal:'https://www.paypal.com/ncp/payment/Z2KD45BKQUXSA' },
    'product-pp-single': { id:'product-pp-single', title:'PP simple', price:'1€', img:'product-3.jpg', desc:"PP simple. Indique ton pseudo Minecraft OU ouvre un ticket Discord. Peut être autre chose qu'un skin.", paypal:'REPLACE_PAYPAL_PP_SINGLE' },
    'product-pp-pack': { id:'product-pp-pack', title:'Pack 5 PP', price:'4€', img:'product-4.jpg', desc:"Pack de 5 PP personnalisées. Précise les idées pour chaque PP.", paypal:'REPLACE_PAYPAL_PP_PACK' },
    'product-subscription': { id:'product-subscription', title:'Abbonement', price:'6€/mois', img:'subscription.jpg', desc:"1 animation courte/mois + 3 PP simples/mois. Annulable.", paypal:'REPLACE_PAYPAL_SUBSCRIPTION' }
  };

  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalImg = document.getElementById('modalImg');
  const modalTitle = document.getElementById('modalTitle');
  const modalPrice = document.getElementById('modalPrice');
  const modalDesc = document.getElementById('modalDesc');
  const modalPaypal = document.getElementById('modalPaypal');
  const modalClose = document.getElementById('modalClose');
  const prevExample = document.getElementById('prevExample');
  const nextExample = document.getElementById('nextExample');

  let lastFocused = null, exampleImages = [], exampleIndex = 0;
  function updateCarouselControls(){ const visible = exampleImages.length > 0; prevExample && (prevExample.style.display = visible ? 'inline-block' : 'none'); nextExample && (nextExample.style.display = visible ? 'inline-block' : 'none'); }

  function openModal(productId){
    const p = PRODUCTS[productId] || null;
    if (!modalBackdrop) return;
    if (p){
      modalImg.src = p.img || '';
      modalImg.alt = p.title || '';
      modalTitle.textContent = p.title || '';
      modalPrice.textContent = p.price || '';
      modalDesc.textContent = p.desc || '';
      modalPaypal.href = p.paypal || '#';
      exampleImages = [];
    } else {
      const card = document.getElementById(productId);
      if (card) {
        modalImg.src = card.querySelector('img')?.src || '';
        modalImg.alt = card.querySelector('img')?.alt || '';
        modalTitle.textContent = card.querySelector('.meta strong')?.textContent || '';
        modalPrice.textContent = card.querySelector('.meta .price')?.textContent || '';
        modalDesc.textContent = card.querySelector('p')?.textContent || '';
        modalPaypal.href = '#';
        exampleImages = [];
      } else return;
    }
    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden','false');
    document.body.classList.add('modal-open');
    lastFocused = document.activeElement;
    modalClose && modalClose.focus();
    exampleIndex = 0;
    updateCarouselControls();
    if (location.hash !== '#' + productId) history.pushState(null,'', '#' + productId);
  }

  function openExamples(list){
    if (!modalBackdrop) return;
    exampleImages = Array.isArray(list) ? list.slice() : [];
    if (exampleImages.length === 0) return;
    exampleIndex = 0;
    modalImg.src = exampleImages[exampleIndex];
    modalImg.alt = 'Exemple ' + (exampleIndex+1);
    modalTitle.textContent = 'Exemples PP';
    modalPrice.textContent = '';
    modalDesc.textContent = 'Aperçu des styles. Pour commander, sélectionne une fiche PP et indique le style souhaité.';
    modalPaypal.href = (PRODUCTS['product-pp-single'] && PRODUCTS['product-pp-single'].paypal) || '#';
    modalBackdrop.style.display = 'flex';
    modalBackdrop.setAttribute('aria-hidden','false');
    document.body.classList.add('modal-open');
    lastFocused = document.activeElement;
    modalClose && modalClose.focus();
    updateCarouselControls();
    if (location.hash !== '#examples') history.pushState(null,'', '#examples');
  }

  function closeModal(){
    if (!modalBackdrop) return;
    modalBackdrop.style.display = 'none';
    modalBackdrop.setAttribute('aria-hidden','true');
    document.body.classList.remove('modal-open');
    if (lastFocused) lastFocused.focus();
    if (location.hash && (location.hash.startsWith('#product-') || location.hash === '#examples')) {
      history.pushState(null,'', location.pathname + location.search);
    }
    exampleImages = []; exampleIndex = 0; updateCarouselControls();
  }

  document.querySelectorAll('.primary-btn[data-id]').forEach(btn=>{ btn.addEventListener('click', ()=> openModal(btn.getAttribute('data-id'))); });
  document.querySelectorAll('.example-btn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const target = btn.getAttribute('data-target');
      const raw = btn.getAttribute('data-examples');
      if (target) { window.location.href = target; return; }
      const list = raw ? raw.split(',').map(s=>s.trim()).filter(Boolean) : ['PP-1.jpg','PP-2.jpg','PP-3.jpg'];
      openExamples(list);
    });
  });

  modalClose && modalClose.addEventListener('click', closeModal);
  modalBackdrop && modalBackdrop.addEventListener('click', (e)=> { if (e.target === modalBackdrop) closeModal(); });
  window.addEventListener('keydown', (e)=> { if (e.key === 'Escape' && modalBackdrop && modalBackdrop.style.display === 'flex') closeModal(); });

  window.addEventListener('hashchange', () => {
    const h = location.hash.replace('#','');
    if (h && h.startsWith('remerciement-')) {
      const key = h.split('-')[1];
      showThanks && showThanks(key);
      return;
    }
    if (h && h.startsWith('product-') && PRODUCTS[h]) setTimeout(()=>openModal(h),80);
  });
  (function checkInitialHash(){ const h = location.hash.replace('#',''); if (h && h.startsWith('product-') && PRODUCTS[h]) setTimeout(()=>openModal(h),80); if (h && h.startsWith('remerciement-')) { const key = h.split('-')[1]; setTimeout(()=> showThanks && showThanks(key), 120); } })();

  /* CONFETTI + THANKS */
  const thanksBackdrop = document.getElementById('thanksBackdrop');
  const thanksTitle = document.getElementById('thanksTitle');
  const thanksMessage = document.getElementById('thanksMessage');
  const thanksDone = document.getElementById('thanksDone');
  const confettiCanvas = document.getElementById('confetti-canvas');

  function launchConfetti(){
    if (!confettiCanvas) return;
    const canvas = confettiCanvas;
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    canvas.style.display = 'block';
    const ctx = canvas.getContext('2d');
    const colors = ['#ff7a18','#ff9b3b','#ffd166','#6ee7b7','#60a5fa','#a78bfa'];
    const num = Math.floor(120 + Math.random()*60);
    const pieces = [];
    for (let i=0;i<num;i++){
      pieces.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height - canvas.height, w: 6 + Math.random()*10, h: 8 + Math.random()*12, r: Math.random()*360, color: colors[Math.floor(Math.random()*colors.length)], speedX: -1 + Math.random()*2, speedY: 2 + Math.random()*4, rotSpeed: -6 + Math.random()*12, opacity: 0.9 + Math.random()*0.1 });
    }
    let start = null;
    function frame(t){
      if (!start) start = t;
      const elapsed = t - start;
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for (let p of pieces){ p.x += p.speedX; p.y += p.speedY; p.r += p.rotSpeed; ctx.save(); ctx.globalAlpha = p.opacity; ctx.translate(p.x,p.y); ctx.rotate(p.r * Math.PI / 180); ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore(); }
      if (elapsed < 4500) requestAnimationFrame(frame);
      else {
        let fadeStart = performance.now();
        (function fade(){
          const fElapsed = performance.now() - fadeStart;
          ctx.clearRect(0,0,canvas.width,canvas.height);
          const alpha = Math.max(0,1 - fElapsed/600);
          for (let p of pieces){ ctx.save(); ctx.globalAlpha = (p.opacity||1)*alpha; ctx.translate(p.x,p.y); ctx.rotate(p.r * Math.PI / 180); ctx.fillStyle = p.color; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore(); }
          if (alpha > 0) requestAnimationFrame(fade);
          else { ctx.clearRect(0,0,canvas.width,canvas.height); canvas.style.display = 'none'; }
        })();
      }
    }
    requestAnimationFrame(frame);
    window.addEventListener('resize', ()=> { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }, { passive:true });
  }

  function showThanks(typeKey){
    if (!thanksBackdrop) return;
    const map = {
      '1': { title: 'Merci pour votre animation !', msg: 'Ta commande d’animation a bien été reçue. Nous te contacterons via Discord ou email pour les détails.' },
      '2': { title: 'Merci pour ta PP !', msg: 'Ta commande de PP a bien été reçue. Indique ton pseudo Minecraft ou ouvre un ticket Discord.' },
      '3': { title: 'Merci pour ton pack PP !', msg: 'Le pack 5 PP a été enregistré. Donne-nous les idées et pseudos via Discord.' },
      '4': { title: 'Merci pour ton abonnement !', msg: 'Bienvenue dans l’abbonement — tu recevras tes livraisons prioritaires chaque mois.' }
    };
    const info = map[typeKey] || map['1'];
    thanksTitle.textContent = info.title;
    thanksMessage.textContent = info.msg;
    thanksBackdrop.style.display = 'flex';
    thanksBackdrop.setAttribute('aria-hidden','false');
    document.body.classList.add('modal-open');
    launchConfetti();
  }
  function closeThanks(){ if (!thanksBackdrop) return; thanksBackdrop.style.display = 'none'; thanksBackdrop.setAttribute('aria-hidden','true'); document.body.classList.remove('modal-open'); }
  thanksDone && thanksDone.addEventListener('click', closeThanks);

  // helper openOrder global
  function openOrder(){ window.location.href = '#order'; }
  window.openOrder = openOrder;

})();
</script>
